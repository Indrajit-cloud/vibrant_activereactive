<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AmbuQuick - Emergency Ambulance Booking</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #2563eb;
            --primary-green: #10b981;
            --emergency-red: #ef4444;
            --dark-red: #dc2626;
            --text-dark: #1f2937;
            --text-light: #6b7280;
            --bg-light: #f9fafb;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, #1d4ed8 100%);
            color: var(--white);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            z-index: 100;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            font-size: 2rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.025em;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .emergency-hotline {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
        }

        /* Map Container */
        .map-container {
            position: relative;
            height: 50vh;
            min-height: 300px;
            background: var(--bg-light);
        }

        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .location-indicator {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background: var(--white);
            padding: 0.75rem 1rem;
            border-radius: 2rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 10;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .location-indicator i {
            color: var(--primary-blue);
        }

        /* Action Buttons */
        .action-section {
            padding: 2rem 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .btn {
            padding: 1.25rem 2rem;
            border: none;
            border-radius: 1rem;
            font-size: 1.125rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .btn i {
            font-size: 2rem;
        }

        .btn-book {
            background: linear-gradient(135deg, var(--primary-green) 0%, #059669 100%);
            color: var(--white);
        }

        .btn-book:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-sos {
            background: linear-gradient(135deg, var(--emergency-red) 0%, var(--dark-red) 100%);
            color: var(--white);
            animation: sosGlow 2s ease-in-out infinite;
        }

        @keyframes sosGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 30px rgba(239, 68, 68, 0.6); }
        }

        .btn-sos:hover {
            transform: scale(1.05);
        }

        .btn:active {
            transform: scale(0.98);
        }

        /* Info Cards */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .info-card {
            background: var(--white);
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .info-card i {
            font-size: 1.5rem;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
        }

        .info-card h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }

        .info-card p {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: var(--white);
            border-radius: 1.5rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: var(--text-dark);
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-blue);
        }

        .form-control:disabled {
            background: var(--bg-light);
            cursor: not-allowed;
        }

        select.form-control {
            cursor: pointer;
        }

        .btn-primary {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #1d4ed8 100%);
            color: var(--white);
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Confirmation Screen */
        .confirmation-screen {
            text-align: center;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: #d1fae5;
            color: #065f46;
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
        }

        .status-badge i {
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .eta-display {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
        }

        .eta-label {
            font-size: 1rem;
            color: var(--text-light);
            margin-bottom: 2rem;
        }

        .driver-card {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .driver-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .driver-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #1d4ed8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .driver-details h3 {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .driver-details p {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .vehicle-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .vehicle-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .vehicle-detail i {
            color: var(--primary-blue);
        }

        .action-buttons-bottom {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn-secondary {
            padding: 1rem;
            background: var(--white);
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--primary-blue);
            color: var(--white);
        }

        .btn-danger {
            padding: 1rem;
            background: var(--white);
            color: var(--emergency-red);
            border: 2px solid var(--emergency-red);
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-danger:hover {
            background: var(--emergency-red);
            color: var(--white);
        }

        /* SOS Screen */
        .sos-screen {
            text-align: center;
            padding: 2rem 1.5rem;
        }

        .sos-header {
            font-size: 2rem;
            font-weight: 800;
            color: var(--emergency-red);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            animation: flashText 1s ease-in-out infinite;
        }

        @keyframes flashText {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .sos-warning {
            font-size: 1rem;
            color: var(--text-light);
            margin-bottom: 2rem;
        }

        .countdown-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto 2rem;
        }

        .countdown-circle {
            width: 200px;
            height: 200px;
            transform: rotate(-90deg);
        }

        .countdown-bg {
            fill: none;
            stroke: #fee2e2;
            stroke-width: 8;
        }

        .countdown-progress {
            fill: none;
            stroke: var(--emergency-red);
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s linear;
        }

        .countdown-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: 800;
            color: var(--emergency-red);
        }

        .btn-cancel {
            width: 100%;
            max-width: 300px;
            padding: 1rem 2rem;
            background: var(--white);
            color: var(--text-dark);
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 auto;
            display: block;
        }

        .btn-cancel:hover {
            background: var(--bg-light);
            border-color: var(--text-dark);
        }

        /* SOS Success Screen */
        .sos-success {
            text-align: center;
        }

        .success-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 1.5rem;
            background: linear-gradient(135deg, var(--primary-green) 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: scaleIn 0.5s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .success-icon i {
            font-size: 3rem;
            color: var(--white);
        }

        .success-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--text-dark);
            margin-bottom: 1rem;
        }

        .success-message {
            font-size: 1rem;
            color: var(--text-light);
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .emergency-contact {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
        }

        .emergency-contact h3 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .contact-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.875rem;
        }

        .contact-item i {
            color: var(--primary-blue);
            width: 20px;
        }

        /* Chatbot */
        .chatbot-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #1d4ed8 100%);
            color: var(--white);
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-xl);
            z-index: 900;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-toggle:hover {
            transform: scale(1.1);
        }

        .chatbot-container {
            position: fixed;
            bottom: 5rem;
            right: 2rem;
            width: 350px;
            max-width: calc(100vw - 3rem);
            height: 500px;
            background: var(--white);
            border-radius: 1.5rem;
            box-shadow: var(--shadow-xl);
            z-index: 900;
            display: none;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        .chatbot-container.active {
            display: flex;
        }

        .chatbot-header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, #1d4ed8 100%);
            color: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 1.5rem 1.5rem 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chatbot-header h3 {
            font-size: 1.125rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .message-bot {
            align-self: flex-start;
        }

        .message-user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #1d4ed8 100%);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .message-user .message-avatar {
            background: linear-gradient(135deg, var(--primary-green) 0%, #059669 100%);
        }

        .message-bubble {
            background: var(--bg-light);
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 70%;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .message-user .message-bubble {
            background: var(--primary-blue);
            color: var(--white);
        }

        .quick-actions {
            padding: 0 1.5rem 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .quick-action-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-light);
            border: 1px solid #e5e7eb;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-action-btn:hover {
            background: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
        }

        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            background: var(--bg-light);
            border-radius: 1rem;
            width: fit-content;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-light);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 5rem;
            right: 2rem;
            background: var(--white);
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            z-index: 2000;
            animation: slideInRight 0.3s ease;
            display: none;
        }

        .toast.active {
            display: flex;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .toast-success {
            border-left: 4px solid var(--primary-green);
        }

        .toast-error {
            border-left: 4px solid var(--emergency-red);
        }

        .toast i {
            font-size: 1.25rem;
        }

        .toast-success i {
            color: var(--primary-green);
        }

        .toast-error i {
            color: var(--emergency-red);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .logo-text {
                font-size: 1.25rem;
            }

            .emergency-hotline {
                font-size: 0.75rem;
                padding: 0.4rem 0.8rem;
            }

            .map-container {
                height: 40vh;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .btn {
                padding: 1.5rem;
            }

            .info-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .chatbot-container {
                right: 1rem;
                width: calc(100vw - 2rem);
            }

            .chatbot-toggle {
                right: 1rem;
            }

            .toast {
                right: 1rem;
                left: 1rem;
            }

            .countdown-container {
                width: 150px;
                height: 150px;
            }

            .countdown-circle {
                width: 150px;
                height: 150px;
            }

            .countdown-number {
                font-size: 3rem;
            }
        }

        @media (max-width: 480px) {
            .action-section {
                padding: 1.5rem 1rem;
            }

            .modal-body {
                padding: 1rem;
            }

            .eta-display {
                font-size: 2.5rem;
            }

            .sos-header {
                font-size: 1.5rem;
            }

            .success-title {
                font-size: 1.5rem;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--white);
            animation: spin 1s ease-in-out infinite;
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-light);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-dark);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-ambulance logo-icon"></i>
                <span class="logo-text">AmbuQuick</span>
            </div>
            <div class="header-info">
                <div class="emergency-hotline">
                    <i class="fas fa-phone-alt"></i>
                    <span>Emergency: 108</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Map Container -->
    <div class="map-container">
        <div id="map"></div>
        <div class="location-indicator">
            <i class="fas fa-map-marker-alt"></i>
            <span id="location-text">Current Location</span>
        </div>
    </div>

    <!-- Action Section -->
    <section class="action-section">
        <div class="action-buttons">
            <button class="btn btn-book" onclick="openBookingModal()">
                <i class="fas fa-ambulance"></i>
                <span>Book Ambulance</span>
            </button>
            <button class="btn btn-sos" onclick="openSOSModal()">
                <i class="fas fa-exclamation-triangle"></i>
                <span>SOS</span>
            </button>
        </div>

        <!-- Location / Simulation Controls -->
        <div style="margin: 1rem 0; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
            <div style="background: white; padding: 0.75rem 1rem; border-radius: 0.75rem; box-shadow: var(--shadow);">
                <strong>Location Mode:</strong>
                <div style="margin-top: 0.5rem; display:flex; gap:0.5rem; align-items:center;">
                    <label style="display:flex; align-items:center; gap:0.25rem;"><input type="radio" name="locMode" id="mode-real" checked> Real</label>
                    <label style="display:flex; align-items:center; gap:0.25rem;"><input type="radio" name="locMode" id="mode-sim"> Simulate</label>
                    <label style="display:flex; align-items:center; gap:0.25rem;"><input type="radio" name="locMode" id="mode-manual"> Manual</label>
                </div>
            </div>

            <div id="sim-controls" style="background:white; padding:0.75rem 1rem; border-radius:0.75rem; box-shadow:var(--shadow); display:none;">
                <strong>Simulation</strong>
                <div style="margin-top:0.5rem; display:flex; gap:0.5rem; align-items:center;">
                    <button class="btn-primary" id="startSimBtn" style="padding:0.5rem 1rem; font-size:0.9rem;">Start Route</button>
                    <button class="btn-secondary" id="stopSimBtn" style="padding:0.5rem 1rem; font-size:0.9rem;">Stop</button>
                </div>
            </div>

            <div id="manual-controls" style="background:white; padding:0.75rem 1rem; border-radius:0.75rem; box-shadow:var(--shadow); display:none;">
                <strong>Manual Location</strong>
                <div style="margin-top:0.5rem; display:flex; gap:0.5rem; align-items:center;">
                    <input type="number" step="any" id="manualLat" placeholder="Latitude" class="form-control" style="width:140px; padding:0.5rem;" />
                    <input type="number" step="any" id="manualLng" placeholder="Longitude" class="form-control" style="width:140px; padding:0.5rem;" />
                    <button class="btn-primary" id="setManualBtn" style="padding:0.5rem 0.75rem; font-size:0.9rem;">Set</button>
                </div>
            </div>
        </div>

        <div class="info-cards">
            <div class="info-card">
                <i class="fas fa-clock"></i>
                <h3>Avg Response Time</h3>
                <p>8 min</p>
            </div>
            <div class="info-card">
                <i class="fas fa-ambulance"></i>
                <h3>Available Now</h3>
                <p>24</p>
            </div>
            <div class="info-card">
                <i class="fas fa-hospital"></i>
                <h3>Hospitals</h3>
                <p>12</p>
            </div>
        </div>
    </section>

    <!-- Booking Modal -->
    <div class="modal-overlay" id="bookingModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-ambulance"></i> Book Ambulance</h2>
                <button class="close-btn" onclick="closeBookingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="bookingForm" onsubmit="submitBooking(event)">
                    <div class="form-group">
                        <label for="pickup">Pickup Location</label>
                        <input type="text" id="pickup" class="form-control" value="Current Location" disabled>
                    </div>
                    
                    <div class="form-group">
                        <label for="hospital">Destination Hospital</label>
                        <select id="hospital" class="form-control" required>
                            <option value="">Loading hospitals...</option>
                        </select>
                        <div id="hospital-info" style="margin-top:0.5rem; font-size:0.95rem; color:var(--text-light);">
                            Nearest hospital: <strong id="nearestHospital">‚Äî</strong>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="condition">Patient Condition</label>
                        <select id="condition" class="form-control" required>
                            <option value="">Select Condition</option>
                            <option value="minor">Minor - Non-Emergency</option>
                            <option value="moderate">Moderate - Requires Attention</option>
                            <option value="critical">Critical - Emergency</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="contact">Contact Number</label>
                        <input type="tel" id="contact" class="form-control" placeholder="+91 98765 43210" pattern="[+0-9\s]+" required>
                    </div>

                    <button type="submit" class="btn-primary">
                        Confirm Booking
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmationModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-check-circle"></i> Booking Confirmed</h2>
                <button class="close-btn" onclick="closeConfirmationModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="confirmation-screen">
                    <div class="status-badge">
                        <i class="fas fa-spinner"></i>
                        <span>Ambulance En Route</span>
                    </div>

                    <div class="eta-display" id="etaDisplay">12</div>
                    <div class="eta-label">minutes away</div>

                    <div class="driver-card">
                        <div class="driver-info">
                            <div class="driver-avatar">RK</div>
                            <div class="driver-details">
                                <h3>Dr. Rajesh Kumar</h3>
                                <p>Paramedic ‚Ä¢ 8 years experience</p>
                            </div>
                        </div>
                        <div class="vehicle-info">
                            <div class="vehicle-detail">
                                <i class="fas fa-ambulance"></i>
                                <span>Advanced Life Support</span>
                            </div>
                            <div class="vehicle-detail">
                                <i class="fas fa-id-card"></i>
                                <span>MH-01-AB-1234</span>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons-bottom">
                        <button class="btn-secondary" onclick="contactDriver()">
                            <i class="fas fa-phone"></i> Contact Driver
                        </button>
                        <button class="btn-danger" onclick="cancelBooking()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SOS Modal -->
    <div class="modal-overlay" id="sosModal">
        <div class="modal">
            <div class="modal-body">
                <div class="sos-screen">
                    <h1 class="sos-header">üö® SOS ACTIVATED üö®</h1>
                    <p class="sos-warning">Emergency services will be notified in:</p>

                    <div class="countdown-container">
                        <svg class="countdown-circle">
                            <circle class="countdown-bg" cx="100" cy="100" r="90"></circle>
                            <circle class="countdown-progress" cx="100" cy="100" r="90" id="countdownProgress"></circle>
                        </svg>
                        <div class="countdown-number" id="countdownNumber">10</div>
                    </div>

                    <button class="btn-cancel" onclick="cancelSOS()">
                        Cancel Emergency Call
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SOS Success Modal -->
    <div class="modal-overlay" id="sosSuccessModal">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-ambulance"></i> Emergency Alert Sent</h2>
                <button class="close-btn" onclick="closeSOSSuccess()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="sos-success">
                    <div class="success-icon">
                        <i class="fas fa-check"></i>
                    </div>

                    <h2 class="success-title">Help is on the way</h2>
                    <p class="success-message">
                        Your location has been shared with the nearest emergency response team. 
                        Stay calm and keep your phone nearby.
                    </p>

                    <div class="eta-display" style="font-size: 2.5rem;">8</div>
                    <div class="eta-label" style="margin-bottom: 1.5rem;">minutes away</div>

                    <div class="emergency-contact">
                        <h3>Emergency Response Team</h3>
                        <div class="contact-list">
                            <div class="contact-item">
                                <i class="fas fa-ambulance"></i>
                                <span>Emergency Medical Services (EMS)</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-phone"></i>
                                <span>+91 108 (Emergency Hotline)</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>Location shared with dispatch</span>
                            </div>
                            <div class="contact-item">
                                <i class="fas fa-clock"></i>
                                <span>Dispatched at: <span id="dispatchTime"></span></span>
                            </div>
                        </div>
                    </div>

                    <button class="btn-primary" onclick="viewSOSDetails()">
                        <i class="fas fa-info-circle"></i> View Details
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot -->
    <button class="chatbot-toggle" onclick="toggleChatbot()" aria-label="Open chatbot">
        <i class="fas fa-comments"></i>
    </button>

    <div class="chatbot-container" id="chatbotContainer">
        <div class="chatbot-header">
            <h3><i class="fas fa-robot"></i> AmbuBot</h3>
            <button class="close-btn" onclick="toggleChatbot()" style="color: white;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="chatbot-messages" id="chatbotMessages">
            <div class="message message-bot">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-bubble">
                    Hello! I'm AmbuBot, your emergency assistant. How can I help you today?
                </div>
            </div>
        </div>
        <div class="quick-actions">
            <button class="quick-action-btn" onclick="chatbotAction('book')">
                üìÖ Book Ambulance
            </button>
            <button class="quick-action-btn" onclick="chatbotAction('emergency')">
                üö® Emergency Tips
            </button>
            <button class="quick-action-btn" onclick="chatbotAction('hospital')">
                üè• Find Hospital
            </button>
            <button class="quick-action-btn" onclick="chatbotAction('first-aid')">
                ‚öïÔ∏è First Aid
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Action completed successfully</span>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Initialize Map
        let map;
        let userMarker;
        let ambulanceMarker;
        let sosCountdownInterval;
        let etaCountdownInterval;

        function initMap() {
            // Default coordinates (India Gate, New Delhi)
            const defaultCoords = [28.6129, 77.2295];
            
            map = L.map('map').setView(defaultCoords, 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // User location marker
            const userIcon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: #2563eb; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                iconSize: [20, 20]
            });

            userMarker = L.marker(defaultCoords, {icon: userIcon}).addTo(map);
            // populate hospitals based on initial/default location
            updateHospitalOptions();
            
            // Try to get user's actual location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const coords = [position.coords.latitude, position.coords.longitude];
                            map.setView(coords, 13);
                            userMarker.setLatLng(coords);
                            document.getElementById('location-text').textContent = 'Your Current Location';
                            updateHospitalOptions();
                    },
                    (error) => {
                        console.log('Location access denied, using default location');
                    }
                );
            }
        }

        // Modal Functions
        function openBookingModal() {
            document.getElementById('bookingModal').classList.add('active');
        }

        function closeBookingModal() {
            document.getElementById('bookingModal').classList.remove('active');
            document.getElementById('bookingForm').reset();
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').classList.remove('active');
            if (etaCountdownInterval) {
                clearInterval(etaCountdownInterval);
            }
            if (ambulanceMarker) {
                map.removeLayer(ambulanceMarker);
                ambulanceMarker = null;
            }
        }

        function submitBooking(event) {
            event.preventDefault();
            
            const hospital = document.getElementById('hospital').value;
            const condition = document.getElementById('condition').value;
            const contact = document.getElementById('contact').value;

            if (!hospital || !condition || !contact) {
                showToast('Please fill all required fields', 'error');
                return;
            }

            // find hospital object and compute distance
            const selectedHospital = hospitals.find(h => h.id === hospital);
            let distanceText = '';
            try {
                if (selectedHospital && userMarker) {
                    const u = userMarker.getLatLng();
                    const d = haversineKm(u.lat, u.lng, selectedHospital.lat, selectedHospital.lng);
                    distanceText = ` (${d.toFixed(1)} km)`;
                }
            } catch (e) {
                distanceText = '';
            }

            closeBookingModal();
            showToast(`Ambulance booking confirmed to ${selectedHospital ? selectedHospital.name : 'selected hospital'}${distanceText}`, 'success');
            
            setTimeout(() => {
                openConfirmationModal();
            }, 500);
        }

        function openConfirmationModal() {
            document.getElementById('confirmationModal').classList.add('active');
            
            // Simulate ambulance approaching
            simulateAmbulanceMovement();
            
            // Start ETA countdown
            let eta = 12;
            document.getElementById('etaDisplay').textContent = eta;
            
            etaCountdownInterval = setInterval(() => {
                eta--;
                if (eta > 0) {
                    document.getElementById('etaDisplay').textContent = eta;
                } else {
                    clearInterval(etaCountdownInterval);
                    showToast('Ambulance has arrived!', 'success');
                }
            }, 5000); // Update every 5 seconds for demo
        }

        function simulateAmbulanceMovement() {
            // Create ambulance marker
            const ambulanceIcon = L.divIcon({
                className: 'ambulance-marker',
                html: '<div style="font-size: 24px; text-align: center;">üöë</div>',
                iconSize: [30, 30]
            });

            // Get user position
            const userPos = userMarker.getLatLng();
            
            // Start ambulance 5km away
            const ambulanceStart = [userPos.lat + 0.05, userPos.lng + 0.05];
            
            ambulanceMarker = L.marker(ambulanceStart, {icon: ambulanceIcon}).addTo(map);
            
            // Animate ambulance movement towards user
            let steps = 0;
            const totalSteps = 12;
            const moveInterval = setInterval(() => {
                steps++;
                const progress = steps / totalSteps;
                const newLat = ambulanceStart[0] + (userPos.lat - ambulanceStart[0]) * progress;
                const newLng = ambulanceStart[1] + (userPos.lng - ambulanceStart[1]) * progress;
                
                ambulanceMarker.setLatLng([newLat, newLng]);
                
                if (steps >= totalSteps) {
                    clearInterval(moveInterval);
                }
            }, 5000);
        }

        function contactDriver() {
            showToast('Calling Dr. Rajesh Kumar...', 'success');
            setTimeout(() => {
                alert('üìû Connected to driver\n\nDr. Rajesh Kumar: "I am 5 minutes away from your location. Please stay at your current location and have your medical documents ready."');
            }, 1000);
        }

        function cancelBooking() {
            if (confirm('Are you sure you want to cancel this booking?')) {
                closeConfirmationModal();
                showToast('Booking cancelled', 'error');
            }
        }

        // SOS Functions
        function openSOSModal() {
            document.getElementById('sosModal').classList.add('active');
            startSOSCountdown();
        }

        function closeSOSModal() {
            document.getElementById('sosModal').classList.remove('active');
            if (sosCountdownInterval) {
                clearInterval(sosCountdownInterval);
            }
        }

        function startSOSCountdown() {
            let countdown = 10;
            const countdownNumber = document.getElementById('countdownNumber');
            const countdownProgress = document.getElementById('countdownProgress');
            
            const circumference = 2 * Math.PI * 90;
            countdownProgress.style.strokeDasharray = circumference;
            countdownProgress.style.strokeDashoffset = 0;

            sosCountdownInterval = setInterval(() => {
                countdown--;
                countdownNumber.textContent = countdown;
                
                const offset = circumference * (countdown / 10);
                countdownProgress.style.strokeDashoffset = circumference - offset;

                if (countdown <= 0) {
                    clearInterval(sosCountdownInterval);
                    activateSOS();
                }
            }, 1000);
        }

        function cancelSOS() {
            closeSOSModal();
            showToast('SOS cancelled', 'error');
        }

        function activateSOS() {
            closeSOSModal();
            
            // Show success modal after brief delay
            setTimeout(() => {
                document.getElementById('sosSuccessModal').classList.add('active');
                
                // Set dispatch time
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                document.getElementById('dispatchTime').textContent = timeString;
                
                showToast('Emergency alert sent successfully!', 'success');
            }, 500);
        }

        function closeSOSSuccess() {
            document.getElementById('sosSuccessModal').classList.remove('active');
        }

        function viewSOSDetails() {
            alert('üöë EMERGENCY RESPONSE DETAILS\n\n' +
                  '‚úì Your SOS alert has been received\n' +
                  '‚úì Emergency Medical Services dispatched\n' +
                  '‚úì ETA: 8 minutes\n' +
                  '‚úì Response Team: Paramedic Unit Alpha-3\n' +
                  '‚úì Your location is being tracked\n\n' +
                  'Stay calm. Help is on the way!');
        }

        // Chatbot Functions
        function toggleChatbot() {
            const chatbot = document.getElementById('chatbotContainer');
            chatbot.classList.toggle('active');
            
            if (chatbot.classList.contains('active')) {
                // Scroll to bottom of messages
                const messages = document.getElementById('chatbotMessages');
                messages.scrollTop = messages.scrollHeight;
            }
        }

        function addBotMessage(message) {
            const messagesContainer = document.getElementById('chatbotMessages');
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'message message-bot';
            typingIndicator.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            messagesContainer.appendChild(typingIndicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Remove typing indicator and show message after delay
            setTimeout(() => {
                messagesContainer.removeChild(typingIndicator);
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message message-bot';
                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-bubble">${message}</div>
                `;
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 1500);
        }

        function addUserMessage(message) {
            const messagesContainer = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-user';
            messageDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="message-bubble">${message}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function chatbotAction(action) {
            let userMessage = '';
            let botResponse = '';

            switch(action) {
                case 'book':
                    userMessage = 'I want to book an ambulance';
                    botResponse = 'Great! I can help you with that. Please click on the "Book Ambulance" button on the main screen to fill in the details. You\'ll need to provide:<br><br>‚Ä¢ Destination hospital<br>‚Ä¢ Patient condition<br>‚Ä¢ Contact number<br><br>The ambulance will arrive within 12 minutes! üöë';
                    break;
                case 'emergency':
                    userMessage = 'I need emergency tips';
                    botResponse = 'Here are some important emergency tips:<br><br>1. Stay calm and assess the situation<br>2. Call emergency services (108) immediately<br>3. Don\'t move the patient unless necessary<br>4. Keep the patient comfortable and warm<br>5. Monitor breathing and pulse<br>6. Keep medical records ready<br><br>For immediate emergency, use the SOS button! üö®';
                    break;
                case 'hospital':
                    userMessage = 'Find nearby hospitals';
                    botResponse = 'Here are the nearest hospitals:<br><br>üè• City General Hospital - 2.3 km<br>üè• Apollo Medical Center - 3.1 km<br>üè• Fortis Healthcare - 4.5 km<br>üè• Max Super Specialty - 5.2 km<br>üè• AIIMS Emergency - 6.8 km<br><br>All hospitals have 24/7 emergency services available.';
                    break;
                case 'first-aid':
                    userMessage = 'Show me first aid information';
                    botResponse = 'Basic First Aid Guidelines:<br><br>For bleeding: Apply pressure with clean cloth<br>For burns: Cool with running water for 10 minutes<br>For choking: Perform Heimlich maneuver<br>For unconsciousness: Check breathing, call 108<br>For heart attack: Give aspirin if available, call emergency<br><br>‚ö†Ô∏è Always call professional help for serious conditions!';
                    break;
            }

            addUserMessage(userMessage);
            addBotMessage(botResponse);
        }

        // Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const icon = toast.querySelector('i');

            toastMessage.textContent = message;
            toast.className = 'toast toast-' + type + ' active';
            
            if (type === 'success') {
                icon.className = 'fas fa-check-circle';
            } else {
                icon.className = 'fas fa-exclamation-circle';
            }

            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }


        // Geolocation & Simulation helpers
        let watchId = null;
        let simTimer = null;
        let simIndex = 0;
        // Sample simulation route (small loop around India Gate)
        const simRoute = [
            [28.6167, 77.2300],
            [28.6145, 77.2330],
            [28.6130, 77.2280],
            [28.6115, 77.2260],
            [28.6129, 77.2295]
        ];

        // Hospitals dataset (id, name, lat, lng)
        const hospitals = [
            { id: 'city-hospital', name: 'City General Hospital', lat: 28.6140, lng: 77.2290 },
            { id: 'apollo', name: 'Apollo Medical Center', lat: 28.6195, lng: 77.2300 },
            { id: 'fortis', name: 'Fortis Healthcare', lat: 28.6050, lng: 77.2305 },
            { id: 'max', name: 'Max Super Specialty Hospital', lat: 28.6178, lng: 77.2250 },
            { id: 'aiims', name: 'AIIMS Emergency', lat: 28.5676, lng: 77.2100 }
        ];

        let hospitalMarkers = [];

        // Haversine distance (km)
        function haversineKm(lat1, lon1, lat2, lon2) {
            const toRad = v => v * Math.PI / 180;
            const R = 6371; // km
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Populate hospital select and place markers; auto-select nearest
        function updateHospitalOptions() {
            const select = document.getElementById('hospital');
            const nearestEl = document.getElementById('nearestHospital');
            if (!select) return;

            // get user position (use userMarker if exists)
            let userLatLng = null;
            try {
                if (userMarker) userLatLng = userMarker.getLatLng();
            } catch (e) { userLatLng = null; }

            const userLat = userLatLng ? userLatLng.lat : null;
            const userLng = userLatLng ? userLatLng.lng : null;

            // compute distances
            const withDist = hospitals.map(h => {
                const d = (userLat !== null && userLng !== null) ? haversineKm(userLat, userLng, h.lat, h.lng) : Infinity;
                return Object.assign({}, h, { distanceKm: d });
            });

            withDist.sort((a,b) => a.distanceKm - b.distanceKm);

            // clear select
            select.innerHTML = '';
            withDist.forEach((h) => {
                const opt = document.createElement('option');
                opt.value = h.id;
                opt.textContent = `${h.name} ‚Äî ${isFinite(h.distanceKm) ? h.distanceKm.toFixed(1) + ' km' : '‚Äî'}`;
                select.appendChild(opt);
            });

            // auto-select nearest (if any)
            if (withDist.length > 0 && isFinite(withDist[0].distanceKm)) {
                select.value = withDist[0].id;
                nearestEl.textContent = `${withDist[0].name} ‚Äî ${withDist[0].distanceKm.toFixed(1)} km`;
            } else if (withDist.length > 0) {
                select.value = withDist[0].id;
                nearestEl.textContent = withDist[0].name;
            } else {
                nearestEl.textContent = '‚Äî';
            }

            // place/update markers
            if (map) {
                // remove old markers
                hospitalMarkers.forEach(m => map.removeLayer(m));
                hospitalMarkers = [];

                withDist.forEach(h => {
                    const marker = L.marker([h.lat, h.lng]).addTo(map);
                    marker.bindPopup(`<strong>${h.name}</strong><br/>${isFinite(h.distanceKm) ? h.distanceKm.toFixed(1) + ' km away' : 'Distance unknown'}`);
                    hospitalMarkers.push(marker);
                });
            }
        }

        function startWatchPosition() {
            if (!navigator.geolocation) {
                showToast('Geolocation not supported by this browser', 'error');
                return;
            }

            // stop any existing simulation
            stopSimulation();

            if (watchId) return; // already watching

            watchId = navigator.geolocation.watchPosition((position) => {
                const coords = [position.coords.latitude, position.coords.longitude];
                if (userMarker) userMarker.setLatLng(coords);
                if (map) map.setView(coords, map.getZoom());
                document.getElementById('location-text').textContent = 'Your Current Location (Real)';
                updateHospitalOptions();
            }, (err) => {
                console.warn('watchPosition error', err);
                showToast('Unable to get live location: ' + (err.message || ''), 'error');
            }, { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 });
        }

        function stopWatchPosition() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                showToast('Stopped real location tracking', 'success');
            }
        }

        function startSimulation() {
            stopWatchPosition();
            if (simTimer) return;
            simIndex = 0;
            // place marker at first point immediately
            const first = simRoute[0];
            if (userMarker) userMarker.setLatLng(first);
            if (map) map.setView(first, map.getZoom());
            document.getElementById('location-text').textContent = 'Simulated Location';

            simTimer = setInterval(() => {
                simIndex = (simIndex + 1) % simRoute.length;
                const coords = simRoute[simIndex];
                if (userMarker) userMarker.setLatLng(coords);
                if (map) map.setView(coords, map.getZoom());
                updateHospitalOptions();
            }, 1500);
            showToast('Simulation started', 'success');
        }

        function stopSimulation() {
            if (simTimer) {
                clearInterval(simTimer);
                simTimer = null;
                showToast('Simulation stopped', 'success');
            }
        }

        function setManualLocation() {
            const lat = parseFloat(document.getElementById('manualLat').value);
            const lng = parseFloat(document.getElementById('manualLng').value);
            if (Number.isFinite(lat) && Number.isFinite(lng)) {
                stopWatchPosition();
                stopSimulation();
                const coords = [lat, lng];
                if (userMarker) userMarker.setLatLng(coords);
                if (map) map.setView(coords, 13);
                document.getElementById('location-text').textContent = 'Manual Location';
                updateHospitalOptions();
                showToast('Manual location set', 'success');
            } else {
                showToast('Please enter valid latitude and longitude', 'error');
            }
        }

        function setModeUI(mode) {
            document.getElementById('sim-controls').style.display = (mode === 'sim') ? 'block' : 'none';
            document.getElementById('manual-controls').style.display = (mode === 'manual') ? 'block' : 'none';

            if (mode === 'real') {
                startWatchPosition();
            } else {
                stopWatchPosition();
            }

            if (mode === 'sim') {
                // do not auto-start; wait for user to click Start Route
            }
        }

        // wire UI events
        document.addEventListener('DOMContentLoaded', () => {
            initMap();

            // initial mode: real
            setModeUI('real');

            // welcome message
            setTimeout(() => {
                showToast('Welcome to AmbuQuick! Emergency services at your fingertips.', 'success');
            }, 1000);

            // radio buttons
            document.getElementById('mode-real').addEventListener('change', () => setModeUI('real'));
            document.getElementById('mode-sim').addEventListener('change', () => setModeUI('sim'));
            document.getElementById('mode-manual').addEventListener('change', () => setModeUI('manual'));

            // simulation buttons
            document.getElementById('startSimBtn').addEventListener('click', () => startSimulation());
            document.getElementById('stopSimBtn').addEventListener('click', () => stopSimulation());

            // manual set
            document.getElementById('setManualBtn').addEventListener('click', (e) => {
                e.preventDefault();
                setManualLocation();
            });

            // when user picks a hospital, update the small info display to show chosen distance
            const hospitalSelect = document.getElementById('hospital');
            if (hospitalSelect) {
                hospitalSelect.addEventListener('change', () => {
                    const sel = hospitals.find(h => h.id === hospitalSelect.value);
                    const nearestEl = document.getElementById('nearestHospital');
                    if (sel && userMarker) {
                        try {
                            const u = userMarker.getLatLng();
                            const d = haversineKm(u.lat, u.lng, sel.lat, sel.lng);
                            nearestEl.textContent = `${sel.name} ‚Äî ${d.toFixed(1)} km`;
                        } catch (e) {
                            nearestEl.textContent = sel.name;
                        }
                    } else if (sel) {
                        nearestEl.textContent = sel.name;
                    }
                });
            }
        });

        // Prevent modal from closing when clicking inside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        });

        // Close modals when clicking overlay
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>